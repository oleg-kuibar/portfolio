---
import BaseLayout from '@/layouts/BaseLayout.astro';
import BlogCard from '@/components/astro/BlogCard.astro';
import { SeriesHeader } from '@/components/react/SeriesHeader';
import { getAllSeries, getSeriesPosts } from '@/lib/series';
import { formatDate } from '@/lib/utils';

export async function getStaticPaths() {
  const allSeries = await getAllSeries();
  return allSeries.map((series) => ({
    params: { slug: series.slug },
    props: { series },
  }));
}

const { series } = Astro.props;
const posts = await getSeriesPosts(series.slug);
---

<BaseLayout
  title={`${series.name} Series | Oleg Kuibar`}
  description={series.description || `A ${series.postCount}-part series on ${series.name.toLowerCase()}`}
>
  <div class="container mx-auto px-4 py-12">
    <!-- Back link -->
    <a
      href="/blog"
      class="inline-flex items-center gap-2 text-muted-foreground hover:text-primary transition-colors mb-8"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m15 18-6-6 6-6"/>
      </svg>
      Back to Blog
    </a>

    <!-- Series Header -->
    <SeriesHeader
      client:load
      name={series.name}
      description={series.description}
      postCount={series.postCount}
      totalReadingTime={series.totalReadingTime}
      latestDate={formatDate(series.latestDate)}
      firstPostSlug={posts[0]?.slug || ''}
    />

    <!-- Series Posts -->
    <section>
      <h2 class="font-heading text-2xl font-semibold mb-6">All Parts</h2>
      <div class="space-y-6">
        {posts.map((post, index) => (
          <div class="relative md:pl-16">
            {/* Part number indicator (desktop) */}
            <div class="absolute left-0 top-6 hidden md:flex flex-col items-center">
              <div class="w-10 h-10 rounded-full bg-primary/10 border-2 border-primary flex items-center justify-center">
                <span class="text-sm font-bold text-primary">
                  {post.partNumber}
                </span>
              </div>
              {index < posts.length - 1 && (
                <div class="w-0.5 flex-1 bg-border mt-2" style="min-height: 100px;" />
              )}
            </div>

            <BlogCard
              title={post.title}
              description={post.description}
              date={post.date}
              slug={post.slug}
              category={post.category}
              tags={post.tags}
              featured={post.featured}
              readingTime={post.readingTime}
              seriesInfo={{
                partNumber: post.partNumber,
                totalParts: series.postCount,
                seriesSlug: series.slug,
              }}
            />
          </div>
        ))}
      </div>
    </section>
  </div>
</BaseLayout>
