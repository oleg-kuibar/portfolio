---
import BaseLayout from '@/layouts/BaseLayout.astro';
import BlogCard from '@/components/astro/BlogCard.astro';
import { SearchDialog } from '@/components/react/SearchDialog';
import { CategoryTabs } from '@/components/react/CategoryTabs';
import { getAllBlogPosts, getFeaturedPosts, getAllCategories, getReadingTime } from '@/lib/blog';
import { getAllSeries, getSeriesCardInfo } from '@/lib/series';

const posts = await getAllBlogPosts();
const featuredPosts = await getFeaturedPosts(3);
const categories = await getAllCategories();
const allSeries = await getAllSeries();

// Prepare posts data for client-side search
const postsData = posts.map((post) => ({
  slug: post.slug,
  title: post.data.title,
  description: post.data.description,
  category: post.data.category,
  tags: post.data.tags,
}));

// Pre-compute series info for all posts (using cache for efficiency)
const postSeriesInfo = new Map<string, Awaited<ReturnType<typeof getSeriesCardInfo>>>();
for (const post of posts) {
  postSeriesInfo.set(post.slug, await getSeriesCardInfo(post, allSeries));
}
---

<BaseLayout
  title="Blog | Oleg Kuibar"
  description="Articles about frontend development, architecture, and engineering leadership."
>
  <div class="container mx-auto px-4 py-12">
    <!-- Header -->
    <div class="max-w-2xl mb-12">
      <h1 class="font-heading text-4xl md:text-5xl font-bold mb-4">Blog</h1>
      <p class="text-lg text-muted-foreground">
        Thoughts on frontend development, system architecture, and engineering leadership.
      </p>
      {allSeries.length > 0 && (
        <a
          href="/blog/series"
          class="inline-flex items-center gap-1.5 mt-4 text-sm text-primary hover:underline"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
          </svg>
          Browse {allSeries.length} blog series â†’
        </a>
      )}
    </div>

    <!-- Search and Filters -->
    <div class="flex flex-wrap items-center gap-4 mb-8">
      <SearchDialog client:load posts={postsData} />
      <CategoryTabs client:load categories={categories} currentCategory={null} />
    </div>

    <!-- Featured Posts -->
    {featuredPosts.length > 0 && (
      <section class="mb-16">
        <h2 class="font-heading text-2xl font-semibold mb-6">Featured</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {featuredPosts.map((post) => (
            <BlogCard
              title={post.data.title}
              description={post.data.description}
              date={post.data.date}
              slug={post.slug}
              category={post.data.category}
              tags={post.data.tags}
              featured={true}
              readingTime={getReadingTime(post.body || '')}
              seriesInfo={postSeriesInfo.get(post.slug)}
            />
          ))}
        </div>
      </section>
    )}

    <!-- All Posts -->
    <section>
      <h2 class="font-heading text-2xl font-semibold mb-6">All Posts</h2>
      {posts.length > 0 ? (
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {posts.map((post) => (
            <BlogCard
              title={post.data.title}
              description={post.data.description}
              date={post.data.date}
              slug={post.slug}
              category={post.data.category}
              tags={post.data.tags}
              featured={post.data.featured}
              readingTime={getReadingTime(post.body || '')}
              seriesInfo={postSeriesInfo.get(post.slug)}
            />
          ))}
        </div>
      ) : (
        <div class="retro-card text-center py-12">
          <div class="inline-block p-4 bg-background border-4 border-border shadow-[8px_8px_0_0_rgba(0,0,0,0.1)] dark:shadow-[8px_8px_0_0_rgba(255,255,255,0.1)] rotate-[-2deg] hover:rotate-0 transition-transform">
            <img
              src="/no-posts.png"
              alt="These aren't the posts you're looking for"
              class="max-w-[280px] md:max-w-[400px] opacity-90 dark:invert"
            />
          </div>
          <p class="text-muted-foreground/70 text-sm mt-6">Check back soon!</p>
        </div>
      )}
    </section>
  </div>
</BaseLayout>
