---
import BaseLayout from './BaseLayout.astro';
import CategoryBadge from '@/components/astro/CategoryBadge.astro';
import SeriesBadge from '@/components/astro/SeriesBadge.astro';
import TagList from '@/components/astro/TagList.astro';
import { SeriesNav } from '@/components/react/SeriesNav';
import { SeriesNavButtons } from '@/components/react/SeriesNavButtons';
import { formatDate } from '@/lib/utils';
import type { SeriesInfo } from '@/lib/series';

interface Props {
  title: string;
  description: string;
  date: Date;
  author: string;
  category: string;
  tags: string[];
  readingTime?: string;
  seriesInfo?: SeriesInfo | null;
}

const { title, description, date, author, category, tags, readingTime, seriesInfo } = Astro.props;

// Calculate previous/next posts by array index (not part number)
const currentIndex = seriesInfo?.posts.findIndex(p => p.partNumber === seriesInfo.currentPart) ?? -1;
const prevPost = currentIndex > 0 ? seriesInfo?.posts[currentIndex - 1] : null;
const nextPost = seriesInfo && currentIndex < seriesInfo.posts.length - 1 ? seriesInfo.posts[currentIndex + 1] : null;
---

<BaseLayout title={`${title} | Oleg Kuibar`} description={description} article={true} publishedTime={date} author={author} tags={tags}>
  <article class="container mx-auto px-4 py-12">
    <!-- Back link -->
    <a
      href="/blog"
      class="inline-flex items-center gap-2 text-muted-foreground hover:text-primary transition-colors mb-8"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m15 18-6-6 6-6"/>
      </svg>
      Back to Blog
    </a>

    <!-- Series indicator -->
    {seriesInfo && (
      <div class="retro-card mb-8 bg-secondary/5">
        <div class="flex flex-wrap items-center gap-3 mb-2">
          <SeriesBadge
            partNumber={seriesInfo.currentPart}
            totalParts={seriesInfo.totalParts}
            seriesSlug={seriesInfo.slug}
          />
          <span class="text-sm text-muted-foreground">
            {seriesInfo.totalReadingTime} for full series
          </span>
        </div>
        <a
          href={`/blog/series/${seriesInfo.slug}`}
          class="text-sm text-primary hover:underline"
        >
          View all parts in "{seriesInfo.name}" â†’
        </a>
      </div>
    )}

    <!-- Header -->
    <header class="mb-8">
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <CategoryBadge category={category} />
        {readingTime && (
          <span class="text-sm text-muted-foreground">{readingTime}</span>
        )}
      </div>

      <h1 class="font-heading text-4xl md:text-5xl font-bold text-foreground mb-4">
        {title}
      </h1>

      <p class="text-xl text-muted-foreground mb-6">
        {description}
      </p>

      <div class="flex flex-wrap items-center gap-4 text-sm text-muted-foreground pb-6 border-b border-border">
        <span>By {author}</span>
        <span class="text-border">|</span>
        <time datetime={date.toISOString()}>
          {formatDate(date)}
        </time>
      </div>
    </header>

    <!-- Content -->
    <div class="prose max-w-none">
      <slot />
    </div>

    <!-- Series navigation footer -->
    {seriesInfo && seriesInfo.posts.length > 1 && (prevPost || nextPost) && (
      <div class="mt-12 pt-8 border-t border-border">
        <h2 class="text-sm font-medium text-muted-foreground mb-4">Continue Reading</h2>
        <SeriesNavButtons
          client:load
          prevPost={prevPost}
          nextPost={nextPost}
        />
      </div>
    )}

    <!-- Tags -->
    {tags.length > 0 && (
      <footer class="mt-12 pt-8 border-t border-border">
        <h2 class="text-sm font-medium text-muted-foreground mb-4">Tags</h2>
        <TagList tags={tags} />
      </footer>
    )}
  </article>

  <!-- Floating series navigation (desktop only) -->
  {seriesInfo && (
    <SeriesNav
      client:load
      seriesSlug={seriesInfo.slug}
      seriesName={seriesInfo.name}
      currentPart={seriesInfo.currentPart}
      totalParts={seriesInfo.totalParts}
      posts={seriesInfo.posts}
      totalReadingTime={seriesInfo.totalReadingTime}
    />
  )}
</BaseLayout>
